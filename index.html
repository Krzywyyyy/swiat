<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa świata — kliknij kraj, aby przejść do strony</title>
  <style>
    :root {
      --bg:#f6f7f9; --text:#172b4d; --muted:#6b7280; --stroke:#9ca3af;
      --highlight:#16a34a; --card:#ffffff; --focus:#2563eb;
    }
    body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:20px;background:#fff;border-bottom:1px solid #e5e7eb}
    h1{margin:0 0 6px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .search{display:flex;gap:8px;align-items:center;background:var(--card);padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px}
    .search input{border:0;outline:0;background:transparent;font-size:16px;min-width:min(280px,60vw)}
    .search button{border:0;padding:8px 12px;border-radius:8px;background:var(--focus);color:#fff;font-weight:600;cursor:pointer}
    main{padding:16px}
    .map-card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:10px}
    #map{width:100%;height:min(70vh,760px)}
    svg{width:100%;height:100%;display:block}
    .country{fill:#fff;stroke:var(--stroke);stroke-width:.6px;cursor:pointer;transition:fill .15s ease}
    .country:hover{fill:#eef2ff}
    .highlighted{fill:var(--highlight)!important;stroke:#0f5132}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:#111827;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transition:opacity .2s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
<header>
  <h1>Interaktywna mapa świata</h1>
  <p>Kliknij kraj, aby przejść do jego strony. Wyszukaj kraj po nazwie — zostanie podświetlony na zielono.</p>
  <div class="toolbar">
    <form class="search" id="searchForm" autocomplete="off">
      <input id="searchInput" type="text" placeholder="np. Polska" aria-label="Wpisz nazwę kraju" />
      <button type="submit">Szukaj</button>
    </form>
</header>

<main>
  <div class="map-card"><div id="map" role="img" aria-label="Mapa świata"></div></div>
</main>

<div class="toast" id="toast">…</div>

<script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script>
(async function(){
  /* ========== USTAWIENIA ========== */
  // Podstrony: rozpoznawane po nazwie (PL i EN)
  const implementedByName = new Map([
    ["polska","countries/polska.html"], ["poland","countries/polska.html"],
    ["niemcy","countries/niemcy.html"], ["germany","countries/niemcy.html"], ["deutschland","countries/niemcy.html"],
    ["japonia","countries/japonia.html"], ["japan","countries/japonia.html"],
    ["brazylia","countries/brazylia.html"], ["brazil","countries/brazylia.html"],
    ["australia","countries/australia.html"], ["australia","countries/australia.html"],
    ["afganistan","countries/afganistan.html"], ["afghanistan","countries/afganistan.html"]
  ]);

  // Aliasowy słownik PL/EN → angielska nazwa z danych (wystarczający, żeby objąć popularne różnice nazw)
  const aliasToEnglish = new Map([
    // najczęstsze polskie endonimy/egzonimy
    ["afganistan","afghanistan"], ["polska","poland"], ["niemcy","germany"], ["japonia","japan"], ["brazylia","brazill"],
    ["australia","australia"]
  ]);

  /* ========== RYSOWANIE MAPY ========== */
  const width = document.getElementById('map').clientWidth;
  const height = document.getElementById('map').clientHeight;
  const svg = d3.select("#map").append("svg").attr("viewBox",[0,0,width,height]);
  const projection = d3.geoNaturalEarth1().fitExtent([[10,10],[width-10,height-10]], {type:"Sphere"});
  const path = d3.geoPath(projection);
  svg.append("path").datum({type:"Sphere"}).attr("d",path).attr("fill","#ffffff");

  const world = await fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(r=>r.json());
  const countries = topojson.feature(world, world.objects.countries).features;

  // Indeks nazw z danych (EN) -> feature
  const nameToFeature = new Map();
  countries.forEach(f => {
    const name = (f.properties && f.properties.name) ? f.properties.name.trim() : "";
    if (name) nameToFeature.set(normalize(name), f);
  });

  const g = svg.append("g");
  const shapes = g.selectAll("path.country")
    .data(countries)
    .join("path")
    .attr("class","country")
    .attr("d", path)
    .attr("data-name", d => d.properties.name)
    .on("click", (e, d) => {
      // przejście do podstrony — po nazwie (PL/EN)
      const en = normalize(d.properties.name);
      const url = implementedByName.get(en) || implementedByName.get(aliasReverse.get(en) || "");
      if (url) window.location.href = url;
      else showToast("Strona tego kraju jest w przygotowaniu.");
    })
    .append("title").text(d => d.properties.name);

  /* ========== WYSZUKIWARKA ========== */
  const searchForm = document.getElementById("searchForm");
  const searchInput = document.getElementById("searchInput");

  // Zbuduj odwrotny alias: EN -> PL alias (pomocniczo dla kliku)
  const aliasReverse = new Map();
  for (const [k,v] of aliasToEnglish.entries()){
    aliasReverse.set(normalize(v), normalize(k));
  }

  function normalize(str){
    return (str||"")
      .toString()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"") // bez znaków diakrytycznych
      .replace(/’/g,"'") // ujednolicenie apostrofów
      .trim()
      .toLowerCase();
  }
  function clearHighlight(){ svg.selectAll(".highlighted").classed("highlighted", false); }
  function highlightFeature(f){
    if(!f) return false;
    // zaznacz
    svg.selectAll(".highlighted").classed("highlighted", false);
    svg.selectAll(".country")
      .filter(d => d === f)
      .classed("highlighted", true);
    return true;
  }

  function resolveToFeature(query){
    const q = normalize(query);
    if(!q) return null;

    // 1) alias PL/EN -> EN
    const enFromAlias = aliasToEnglish.get(q);
    if (enFromAlias) {
      const f = nameToFeature.get(normalize(enFromAlias));
      if (f) return f;
    }

    // 2) dokładna nazwa EN z danych
    const exact = nameToFeature.get(q);
    if (exact) return exact;

    // 3) zaczyna się od…
    let found = null;
    for (const [name, f] of nameToFeature.entries()){
      if (name.startsWith(q)) { found = f; break; }
    }
    if (found) return found;

    // 4) zawiera…
    for (const [name, f] of nameToFeature.entries()){
      if (name.includes(q)) { found = f; break; }
    }
    return found;
  }

  searchForm.addEventListener("submit", (e)=>{
    e.preventDefault();
    const q = searchInput.value || "";
    const f = resolveToFeature(q);
    if (highlightFeature(f)) {
      // komunikat oraz podpowiedź, czy jest podstrona
      const enName = normalize(f.properties.name);
      const hasPage = implementedByName.has(enName) || implementedByName.has(aliasReverse.get(enName) || "");
      showToast(hasPage ? "Kraj znaleziony. Kliknij, aby przejść do podstrony." : "Kraj znaleziony. Podstrona w przygotowaniu.");
    } else {
      showToast("Nie znaleziono takiego kraju.");
    }
  });

  function showToast(msg){
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>el.classList.remove("show"), 2000);
  }
})();
</script>
</body>
</html>
